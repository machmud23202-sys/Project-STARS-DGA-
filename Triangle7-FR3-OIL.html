<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DGA Check | THE Duval Triangle 7 FOR THERMAL FAULT (FR3 OIL)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
  body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fb; margin: 0; padding: 0; }
  header { background-color: #003399; color: white; padding: 15px 40px; font-size: 20px; font-weight: bold; }
  .main { display:flex; justify-content:space-between; margin:20px auto; width:90%; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); padding:20px;}
  .input-section { width:30%; }
  .chart-section { width:65%; }
  label { font-weight:600; display:block; margin-top:10px; }
  input { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
  button { background-color:#003399; color:white; border:none; padding:10px 15px; border-radius:5px; margin-top:15px; font-weight:bold; cursor:pointer;}
  button:hover { background-color:#001f66; }
  .hasil { margin-top:15px; background-color:#eef2ff; border-left:5px solid #003399; padding:15px; border-radius:5px; font-size:15px; line-height:1.6; }
  .hasil b { color:#001f66; }
  h2 { color:#003399; font-size:18px; border-bottom:2px solid #003399; padding-bottom:5px; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th { background-color:#003399; color:white; padding:12px; text-align:center; }
  td { border:1px solid #ddd; padding:8px; text-align:center; }
  .action-buttons { margin-top:15px; text-align:right; }
  .btn-excel { background-color:#003399; margin-right:10px; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
  .btn-delete { background-color:#c62828; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
  footer { background-color:#003399; color:white; text-align:center; padding:10px; margin-top:40px; }
  .toast { position:fixed; bottom:25px; right:25px; background-color:#003399; color:white; padding:10px 16px; border-radius:6px; opacity:0; transition:opacity 0.4s ease; pointer-events:none; font-size:14px; }
  .toast.show { opacity:1; pointer-events:auto; }

  /* ===========================
      CSS HELP POPUP DITEMPEL DI SINI
     =========================== */
  .help-btn {
    position: fixed;
    bottom: 25px;
    right: 25px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #1976d2;
    color: #fff;
    font-size: 22px;
    border: none;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    z-index: 999;
  }

  .help-popup {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
  }

  .help-content {
    background: #fff;
    width: 60%;
    max-width: 650px;
    margin: 3% auto;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
  }

  .close-help {
    float: right;
    font-size: 28px;
    cursor: pointer;
    color: #666;
  }

  .close-help:hover {
    color: #000;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
    
  }
  .input-select {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid #d0d7e2;
  border-radius: 8px;
  font-size: 15px;
  background: white;
  cursor: pointer;
}

.input-select:focus {
  border-color: #1a73e8;
  box-shadow: 0 0 4px rgba(26,115,232,0.4);
  outline: none;
}
</style>

</head>
<body>

<header>DGA Check | THE Duval Triangle 7 FOR THERMAL FAULT (FR3 OIL)
<header>
  DGA Check | THE Duval Triangle 7 FOR THERMAL FAULT (FR3 OIL)
  <a href="Halaman ke 2.html"
     style="text-decoration:none; background-color:#003399; color:white; padding:8px 14px; border-radius:6px; position:absolute; right:40px; top:12px; font-size:15px; transition:background-color 0.2s;">
     ‚¨Ö Kembali
  </a>
</header>
  
<div class="main">
  <div class="input-section">
  <h2>Duval Triangle 7 FOR THERMAL FAULT (FR3 OIL)</h2>

    <div class="row">
  <select id="upSelect" class="input-select"></select>
  <button id="btnDeleteUP" class="btn-small" style="display:none;">Hapus UP</button>
</div>

    <!-- Pilihan Trafo -->
    <div class="row">
      <select id="trafoSelect" class="input-select"></select>
      <button id="btnDeleteTrafo" class="btn-small" style="display:none;">Hapus Trafo</button>
    </div>

    <!-- Tambah UP & Trafo -->
    <div class="row">
      <button id="btnAddUP" class="btn-small">Tambah UP</button>
      <button id="btnAddTrafo" class="btn-small">Tambah Trafo</button>
    </div>

    <label for="tanggalUji">Tanggal Pengujian</label>
    <input id="tanggalUji" type="date">

    <label for="ch4">CH‚ÇÑ (Methane):</label>
    <input id="ch4" type="number" placeholder="contoh: 20" />

    <label for="c2h4">C‚ÇÇH‚ÇÑ (Ethylene):</label>
    <input id="c2h4" type="number" placeholder="contoh: 30" />

    <label for="c2h6">C‚ÇÇH‚ÇÜ (Ethane):</label>
    <input id="c2h6" type="number" placeholder="contoh: 10" />

    

  <!-- Tombol sejajar -->
    <div class="button-row">
      <button onclick="hitungDanPlot()">Hitung & Simpan</button>
      <input type="file" id="excelFile" accept=".xlsx, .xls" class="btn-import">
    </div>

    <!-- Hasil analisis -->
    <div class="hasil" id="hasilText">Hasil analisis akan muncul di sini.</div>
  </div>

  <!-- Grafik di sisi kanan -->
  <div class="chart-section">
    <div id="duvalPlot" style="width:100%; height:500px;"></div>
  </div>
</div>


<div class="container" style="width:90%; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1);">
  <h2>Riwayat Analisis</h2>
  <table id="hasilTable">
    <thead>

      <tr>
      <th>No</th>
      <th>UP</th>
      <th>Trafo</th>
      <th>Tanggal Uji</th>
      <th>Tanggal Input</th>
      <th>CH‚ÇÑ</th>
      <th>C‚ÇÇH‚ÇÑ</th>
      <th>C‚ÇÇH‚ÇÜ</th>
      <th>Fault</th>
      <th>Rekomendasi</th>


      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="action-buttons">
  <button class="btn-excel" onclick="downloadExcel()">üì• Unduh Excel</button>
  <button class="btn-delete" onclick="hapusSemua()">üóëÔ∏è Hapus Semua</button>
</div>

</div>

<footer>¬© 2025 DGA Check | PLN Nusantara Power</footer>

<div class="toast" id="toast">Data disimpan ke Excel</div>
<button id="helpBtn" class="help-btn">?</button>

<div id="helpPopup" class="help-popup">
  <div class="help-content">
    <span id="closeHelp" class="close-help">&times;</span>
    <h2> Duval Triangle 7 FOR THERMAL FAULT (FR3 OIL) - Help / Info</h2>

<p><b>Duval Triangle 7 (Thermal Fault ‚Äì FR3 Oil)</b> digunakan untuk menganalisis gangguan termal pada transformator yang menggunakan minyak FR3. Diagram ini memetakan proporsi <b>CO</b>, <b>CO‚ÇÇ</b>, dan <b>C‚ÇÇH‚ÇÑ</b> untuk mendeteksi tingkat pemanasan minyak dan selulosa, serta mengidentifikasi potensi titik panas yang berkembang.</p> 
<p>DT7 digunakan untuk membedakan beberapa kategori gangguan termal, seperti pemanasan rendah, menengah, hingga tinggi, berdasarkan pola kenaikan gas CO/CO‚ÇÇ akibat degradasi kertas isolasi dan peningkatan C‚ÇÇH‚ÇÑ sebagai indikator pemanasan minyak. Pada kondisi normal, FR3 Oil menghasilkan CO‚ÇÇ lebih dominan dibanding CO, sehingga titik analisis biasanya berada pada area non-fault. Perpindahan titik menuju zona thermal fault menunjukkan kenaikan temperatur yang signifikan dan perlu dilakukan evaluasi lebih lanjut.</p> 
<p>Karena karakteristik pembentukan gas pada FR3 berbeda dari minyak mineral‚Äîkhususnya pada rasio CO/CO‚ÇÇ dan respon gas terhadap panas‚Äîoperator dianjurkan membuat <b>baseline</b> gas normal masing-masing transformator untuk mendeteksi perubahan kecil yang mengarah pada gangguan termal.</p> 
<h3>Catatan:</h3> 
<p>Pola degradasi FR3 Oil menghasilkan CO dan CO‚ÇÇ dengan rasio yang berbeda dari minyak mineral, sehingga area operasi normal aktual dapat lebih sempit dari batas zona standar dalam DT7. Pergerakan titik keluar baseline dapat menjadi indikasi awal pemanasan yang memburuk dan berpotensi berkembang menjadi thermal fault tingkat lebih tinggi.</p>
  </div>
</div>


<!-- ===================================
      JAVASCRIPT POPUP
==================================== -->
<script>
  const helpBtn = document.getElementById("helpBtn");
  const helpPopup = document.getElementById("helpPopup");
  const closeHelp = document.getElementById("closeHelp");

  helpBtn.onclick = () => helpPopup.style.display = "block";
  closeHelp.onclick = () => helpPopup.style.display = "none";

  window.onclick = (e) => {
    if (e.target === helpPopup) helpPopup.style.display = "none";
  };
</script>

<script>
//DATABASE PLN NP

let databaseUP = {
  "UP Gresik": ["Trafo Unit 1", "Trafo Unit 2", "Trafo Unit 3"],
  "UP Paiton": ["Trafo GT1", "Trafo GT2"],
  "UP Muara Karang": ["Trafo 1", "Trafo 2"],
  "UP Muara Tawar": ["Trafo 1", "Trafo 2", "Trafo 3"],
  "UP Indramayu": ["Trafo Unit 1"],
  "UP Cirata": ["Trafo 1", "Trafo 2"],
  "UP Saguling": ["Trafo 1", "Trafo 2"],
  "UP Grati": ["Trafo GT1", "Trafo GT2"],
  "UP Kamojang": ["Trafo Geothermal 1", "Trafo Geothermal 2"]
};

databaseUP = JSON.parse(localStorage.getItem("dbUpTrafo")) || databaseUP;
const saveDB = () => localStorage.setItem("dbUpTrafo", JSON.stringify(databaseUP));

/* ============================
   LOAD UP
============================ */
function loadUP() {
  const upSel = document.getElementById("upSelect");
  upSel.innerHTML = `<option value="">-- Pilih UP --</option>` +
    Object.keys(databaseUP).map(u => `<option>${u}</option>`).join("");
}

/* ============================
   LOAD TRAFO SESUAI UP
============================ */
function loadTrafo(up) {
  const trSel = document.getElementById("trafoSelect");
  trSel.innerHTML = `<option value="">-- Pilih Trafo --</option>`;

  if (!up) return;

  trSel.innerHTML += databaseUP[up]
    .map(t => `<option>${t}</option>`)
    .join("");
}

/* ============================
   EVENT SELECT UP
============================ */
document.getElementById("upSelect").addEventListener("change", function () {
  const up = this.value;
  loadTrafo(up);

  document.getElementById("btnDeleteUP").style.display = up ? "inline-block" : "none";
});

/* ============================
   EVENT SELECT TRAFO
============================ */
document.getElementById("trafoSelect").addEventListener("change", function () {
  const tr = this.value;
  document.getElementById("btnDeleteTrafo").style.display = tr ? "inline-block" : "none";
});

/* ============================
   TAMBAH UP
============================ */
document.getElementById("btnAddUP").addEventListener("click", () => {
  const newUP = prompt("Nama UP baru:");
  if (!newUP) return;

  if (databaseUP[newUP]) return alert("UP sudah ada!");

  databaseUP[newUP] = [];
  saveDB();
  loadUP();
});

/* ============================
   TAMBAH TRAFO
============================ */
document.getElementById("btnAddTrafo").addEventListener("click", () => {
  const up = document.getElementById("upSelect").value;
  if (!up) return alert("Pilih UP dulu!");

  const newTrafo = prompt("Nama trafo baru:");
  if (!newTrafo) return;

  databaseUP[up].push(newTrafo);
  saveDB();
  loadTrafo(up);
});

/* ============================
   HAPUS UP
============================ */
document.getElementById("btnDeleteUP").addEventListener("click", () => {
  const up = document.getElementById("upSelect").value;
  if (!up) return;

  if (confirm(`Hapus UP "${up}" beserta seluruh Trafonya?`)) {
    delete databaseUP[up];
    saveDB();
    loadUP();
    document.getElementById("trafoSelect").innerHTML = `<option value="">-- Pilih Trafo --</option>`;
    document.getElementById("btnDeleteUP").style.display = "none";
    document.getElementById("btnDeleteTrafo").style.display = "none";
  }
});

/* ============================
   HAPUS TRAFO
============================ */
document.getElementById("btnDeleteTrafo").addEventListener("click", () => {
  const up = document.getElementById("upSelect").value;
  const tr = document.getElementById("trafoSelect").value;

  if (!tr) return;

  if (confirm(`Hapus Trafo "${tr}"?`)) {
    databaseUP[up] = databaseUP[up].filter(t => t !== tr);
    saveDB();
    loadTrafo(up);
    document.getElementById("btnDeleteTrafo").style.display = "none";
  }
});

/* ============================
   INITIAL LOAD
============================ */
document.addEventListener("DOMContentLoaded", loadUP);

</script>



<script>
  // Saat halaman pertama kali dibuka: plot kosong
  document.addEventListener("DOMContentLoaded", () => {
    plotDuval(0, 0, 0, null);
  });

  // Isi default tanggal uji = hari ini kalau belum diisi
  document.addEventListener("DOMContentLoaded", function () {
    const today = new Date().toISOString().split("T")[0];
    const tUji = document.getElementById("tanggalUji");
    if (tUji && !tUji.value) {
      tUji.value = today;
    }
  });

  const STORAGE_KEY = "riwayat_Duval7_FTF_FR3_OIL";
  let hasilData = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  updateTable();

/* =Regions (swapped)= */
const regions = [
  { name: 'PD', color: 'rgba(255, 235, 59, 0.7)', short: 'PD',
    coords: [
      [100,-1,-1],
      [100,1,0],
      [100,0,1],
    ]
  },

  { name: 'O', color: 'rgba(66,133,244,0.55)', short: 'O',
    coords: [
      [100,0,1],
      [100,1,0],
      [200,340,0],
      [260,590,90],
      [100,0,11],
    ]
  },

  { name: 'S', color: 'rgba(131,10,161,0.55)', short: 'S',
    coords: [
      [200,340,0],
      [-1,100,-1],
      [0,960,140],
      [290,750,150],
    ]
  },

  { name: 'C', color: 'rgba(244,67,54,0.25)', short: 'C',
    coords: [
      [100,0,11],
      [820,400,130],
      [600,510,590],
      [100,0,53],
    ]
  },

  { name: 'T3', color: 'rgba(102,187,106,0.35)', short: 'DT',
    coords: [
      [100,0,53],
      [-1,-1,100],
      [0,643,357],
    ]
  },

  { name: 'N/D', color: 'rgba(255,167,38,0.4)', short: 'D1',
    coords: [
      [0,960,140],
      [290,750,150],
      [260,590,90],
      [820,400,130],
      [600,510,590],
      [0,643,357],
    ]
  },
];


  // === KONVERSI TERNARY ‚Üí KOORDINAT 2D ===
  function ternaryToXY(a, b, c) {
    const s = a + b + c;
    if (s === 0) return { x: 0, y: 0 };
    const an = a / s, bn = b / s, cn = c / s;
    const sqrt3over2 = Math.sqrt(3) / 2;
    return { x: 1 - (0.5 * an + cn), y: an * sqrt3over2 };
  }

  // === CEK TITIK DALAM POLYGON ===
  function pointInPolygon2D(point, polygon) {
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i].x, yi = polygon[i].y;
      const xj = polygon[j].x, yj = polygon[j].y;
      const intersect = ((yi > point.y) !== (yj > point.y)) &&
        (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  // === DETEKSI ZONA ===
  function detectRegionForPoint(a, b, c) {
    const pt = ternaryToXY(a, b, c);
    for (let r of regions) {
      const poly = r.coords.map(p => ternaryToXY(p[0], p[2], p[1]));
      if (pointInPolygon2D(pt, poly)) return r;
    }
    return null;
  }

  // === FUNGSI UTAMA HITUNG & PLOT (INPUT MANUAL) ===
  function hitungDanPlot() {

    const up    = document.getElementById("upSelect").value || "-";
    const trafo = document.getElementById("trafoSelect").value || "-";

    const today = new Date().toISOString().split("T")[0];
    const tUjiInput = document.getElementById("tanggalUji").value;
    const tanggalUji   = tUjiInput || today;   // kalau kosong, pakai hari ini
    const tanggalInput = today;               // tanggal input = hari ini

    const ch4  = parseFloat(document.getElementById("ch4").value);
    const c2h4 = parseFloat(document.getElementById("c2h4").value);
    const c2h6 = parseFloat(document.getElementById("c2h6").value);

    if (!up || !trafo) {
      alert("Pilih UP dan Trafo terlebih dahulu!");
      return;
    }

    if (isNaN(ch4) || isNaN(c2h4) || isNaN(c2h6) || (ch4 + c2h4 + c2h6) === 0) {
      alert("Isi semua nilai gas dengan benar!");
      return;
    }

    const total = ch4 + c2h4 + c2h6;
    const pCH4  = (ch4  / total) * 100;
    const pC2H4 = (c2h4 / total) * 100;
    const pC2H6 = (c2h6 / total) * 100;

    // === LOW NORMAL HANDLING ===
    if (ch4 < 25 && c2h4 < 20 && c2h6 < 15) {

      const hasilLow = "Low Normal";
      const rekomLow = [
        "Peralatan dalam kondisi normal.",
        "Monitoring rutin sesuai jadwal.",
        "Tidak diperlukan tindakan korektif."
      ];

      document.getElementById("hasilText").innerHTML =
        `<b>Hasil:</b> ${hasilLow}<br><b>Rekomendasi:</b><ol>${rekomLow.map(r => `<li>${r}</li>`).join('')}</ol>`;

      hasilData.push({
        up,
        trafo,
        tanggalUji,
        tanggalInput,
        ch4, c2h4, c2h6,
        fault: hasilLow,
        rekom: rekomLow.join("; ")
      });

      saveToStorage();
      updateTable();
      Plotly.purge("duvalPlot");
      return;
    }

    // === DETEKSI FAULT ZONA DUVAL ===
    const found = detectRegionForPoint(pCH4, pC2H4, pC2H6);
    const fault = found ? found.name : "Tidak terklasifikasi";
    const info  = rekomendasiMap[fault];

    document.getElementById("hasilText").innerHTML = info
      ? `<b>Hasil:</b> ${info.hasil}<br><b>Rekomendasi:</b><ol>${info.rekom.map(r=>`<li>${r}</li>`).join('')}</ol>`
      : `<b>Hasil:</b> ${fault}`;

    hasilData.push({
      up,
      trafo,
      tanggalUji,
      tanggalInput,
      ch4, c2h4, c2h6,
      fault,
      rekom: info ? info.rekom.join("; ") : "-"
    });

    saveToStorage();
    updateTable();
    plotDuval(pCH4, pC2H4, pC2H6, found);
  }

  // === PLOT SEGITIGA DUVAL ===
  function plotDuval(aVal = 0, bVal = 0, cVal = 100, foundRegion = null) {
    const traces = regions.map(r => ({
      type: 'scatterternary',
      mode: 'lines',
      fill: 'toself',
      fillcolor: r.color,
      line: { color: 'black', width: 1 },
      name: r.name,
      a: r.coords.map(p => p[0]), 
      b: r.coords.map(p => p[1]),
      c: r.coords.map(p => p[2])  
    }));

    const point = {
      type: 'scatterternary',
      mode: 'markers',
      a: [aVal],
      b: [cVal], 
      c: [bVal], 
      marker: {
        color: foundRegion ? foundRegion.color : 'black',
        size: 14,
        line: { color: '#222', width: 1 }
      },
      name: 'Hasil'
    };

    const layout = {
      ternary: {
        sum: 100,
        aaxis: { title: '', ticksuffix: '', dtick: 10 },
        baxis: { title: '', ticksuffix: '', dtick: 10 },
        caxis: { title: '', ticksuffix: '', dtick: 10 }
      },
      annotations: [
        { text: "% CH‚ÇÑ ‚Üí", x: 0.22, y: 0.5, textangle: -60, showarrow: false, font: { size: 14, color: '#003399' } },
        { text:" % C‚ÇÇH‚ÇÑ ‚Üí" , x: 0.78, y: 0.5, textangle: 60, showarrow: false, font: { size: 14, color: '#003399' } },
        { text: "‚Üê % C‚ÇÇH‚ÇÜ", x: 0.5, y: -0.15, textangle: 0, showarrow: false, font: { size: 14, color: '#003399' } }
      ],
      title: 'Duval Triangle 7 FOR THERMAL FAULT (FR3 OIL)',
      height: 500,
      showlegend: true,
      legend: { orientation: 'h', x: 0.1, y: -0.12 }
    };

    Plotly.react('duvalPlot', [point, ...traces], layout);
  }

/* === rekomendasi map (pakai yang kamu kirim) === */
const rekomendasiMap = {
  "PD": {
    hasil: "Partial Discharge (PD)",
    rekom: [
      " Lakukan uji DGA lanjutan dalam 1‚Äì3 bulan.",
      " Periksa kelembapan minyak dan kondisi celah udara internal.",
      " Lakukan inspeksi visual bila tersedia jendela/akses internal.",
      " Monitor tren gas H‚ÇÇ untuk mendeteksi peningkatan aktivitas PD."
    ]
  },
  "S": {
    hasil: "Stray Gassing of FR3 Oil (S)",
    rekom: [
      " Tidak perlu tindakan korektif langsung.",
      " Pastikan sampel minyak diambil ulang setelah 6 bulan untuk konfirmasi.",
      " Catat tren gas ringan (CH‚ÇÑ, C‚ÇÇH‚ÇÜ) untuk memastikan kestabilan.",
      " Verifikasi suhu operasi trafo tidak melebihi ambang desain FR3."
    ]
  },
  "O": {
    hasil: "Overheating < 250¬∞C (O)",
    rekom:[
      " Periksa beban transformator dan kondisi pendinginan.",
      " Lakukan termografi inframerah untuk deteksi titik panas eksternal",
      " Ukur tahanan kontak pada tap changer atau koneksi terminal.",
      " Ulangi DGA setelah 1‚Äì2 bulan untuk melihat tren kenaikan gas."
    ]
  },
  "C": {
    hasil: "Hot Spot with Carbonization > 300¬∞C (C)",
    rekom: [
      " Lakukan inspeksi internal (offline test) bila memungkinkan.",
      " Analisis rasio gas CH‚ÇÑ/C‚ÇÇH‚ÇÑ/C‚ÇÇH‚ÇÜ untuk menilai stabilitas hotspot.",
      " Pantau tren gas harian/mingguan, terutama CH‚ÇÑ dan CO.",
      " Jika peningkatan signifikan, rencanakan shutdown untuk verifikasi fisik."
    ]
  },
  "T3": {
    hasil: "Severe Thermal Fault > 700 ¬∞C (T3)",
    rekom: [
      " Segera matikan transformator (emergency shutdown).",
      " Lakukan uji visual internal dan termal, cari sumber panas ekstrem.",
      " Uji resistansi belitan dan tap changer.",
      " Ganti minyak dan uji ulang DGA setelah perbaikan untuk memastikan stabilitas."
    ]
  },
  "N/D": {
    hasil: "Not Determined (N/D)",
    rekom: [
      " Ulangi sampling DGA dalam 1 bulan.",
      " Verifikasi kondisi operasional trafo (beban & suhu).",
      " Pastikan kualitas sampel dan metode pengambilan benar.",
      " Bila tren gas meningkat, lakukan analisis lanjutan dengan Triangle 3."
    ]
  },
};

  // === UPDATE TABEL ===
  function updateTable() {
    const tbody = document.querySelector("#hasilTable tbody");

    if (!hasilData.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="10" style="color:#888; text-align:center;">Belum ada data</td>
        </tr>`;
      return;
    }

    tbody.innerHTML = hasilData
      .map((d, i) => {
        const rekomList = d.rekom && d.rekom !== "-"
          ? d.rekom.split(";").map((r, idx) => `<div>${idx + 1}. ${r.trim()}</div>`).join("")
          : "-";

        return `
          <tr>
            <td>${i + 1}</td>
            <td>${d.up || "-"}</td>
            <td>${d.trafo || "-"}</td>
            <td>${d.tanggalUji || "-"}</td>
            <td>${d.tanggalInput || "-"}</td>
            <td>${d.ch4}</td>
            <td>${d.c2h4}</td>
            <td>${d.c2h6}</td>
            <td>${d.fault}</td>
            <td>${rekomList}</td>
          </tr>
        `;
      })
      .join("");
  }

  function hapusSemua(){
    if(confirm("Hapus semua riwayat analisis?")){
      hasilData=[];
      localStorage.removeItem(STORAGE_KEY);
      updateTable();
    }
  }

  function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(hasilData));
  }

  // Helper konversi tanggal Excel ‚Üí yyyy-mm-dd
  function safeExcelDate(value) {
    if (!value) return "-";
    if (value instanceof Date) {
      return value.toISOString().split("T")[0];
    }
    if (typeof value === "number") {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const d = new Date(excelEpoch.getTime() + value * 86400000);
      return d.toISOString().split("T")[0];
    }
    if (typeof value === "string") {
      const d = new Date(value);
      if (!isNaN(d)) return d.toISOString().split("T")[0];
      return value;
    }
    return "-";
  }

  /* =======================
     Excel Import (SheetJS)
  ======================= */
  document.getElementById('excelFile').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];

      const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
      const today = new Date().toISOString().split("T")[0];

      rows.forEach(row => {
        const up      = row.UP || row["Nama UP"] || "-";
        const trafo   = row.Trafo || row["Nama Trafo"] || "-";
        const tanggalUji   = safeExcelDate(row["Tanggal Uji"] || row.Tanggal || "");
        const tanggalInput = today;

        const ch4  = Number(row.CH4  || 0);
        const c2h4 = Number(row.C2H4 || 0);
        const c2h6 = Number(row.C2H6 || 0);

        if ((ch4 + c2h4 + c2h6) === 0) return;

        // LOW NORMAL
        if (ch4 < 25 && c2h4 < 20 && c2h6 < 15) {
          const rekomLowNormal = [
            "Peralatan dalam kondisi normal.",
            "Lakukan monitoring rutin sesuai jadwal.",
            "Tidak diperlukan tindakan korektif."
          ];

          hasilData.push({
            up,
            trafo,
            tanggalUji,
            tanggalInput,
            ch4, c2h4, c2h6,
            fault: "NORMAL",
            rekom: rekomLowNormal.join("; ")
          });

          return;
        }

        const total = ch4 + c2h4 + c2h6;
        const pCH4  = (ch4  / total) * 100;
        const pC2H4 = (c2h4 / total) * 100;
        const pC2H6 = (c2h6 / total) * 100;

        const found = detectRegionForPoint(pCH4, pC2H4, pC2H6);
        const fault = found ? found.name : "Tidak terklasifikasi";
        const info  = rekomendasiMap[fault];

        hasilData.push({
          up,
          trafo,
          tanggalUji,
          tanggalInput,
          ch4, c2h4, c2h6,
          fault,
          rekom: info ? info.rekom.join("; ") : "-"
        });
      });

      saveToStorage();
      updateTable();

      // Re-plot semua titik (kecuali NORMAL)
      Plotly.purge('duvalPlot');

      const traces = hasilData
        .filter(d => d.fault !== "NORMAL")
        .map((d, i) => {
          const total = d.ch4 + d.c2h4 + d.c2h6;
          if (total === 0) return null;

          const pCH4  = (d.ch4  / total) * 100;
          const pC2H4 = (d.c2h4 / total) * 100;
          const pC2H6 = (d.c2h6 / total) * 100;

          return {
            type: 'scatterternary',
            mode: 'markers+text',
            a: [pCH4],
            b: [pC2H6],
            c: [pC2H4],
            marker: {
              size: 10,
              color: 'black',
              symbol: 'circle',
              line: { color: 'white', width: 1 }
            },
            text: [`S${i + 1}`],
            textposition: 'top center',
            showlegend: false 
          };
        }).filter(Boolean);

      const areaTraces = regions.map(r => ({
        type: 'scatterternary',
        mode: 'lines',
        fill: 'toself',
        fillcolor: r.color,
        line: { color: 'black', width: 1 },
        name: r.name,
        a: r.coords.map(p => p[0]),
        b: r.coords.map(p => p[1]),
        c: r.coords.map(p => p[2])
      }));

      Plotly.react('duvalPlot', [...areaTraces, ...traces], {
        ternary: {
          sum: 100,
          aaxis: { title: '', ticksuffix: '', dtick: 10 },
          baxis: { title: '', ticksuffix: '', dtick: 10 },
          caxis: { title: '', ticksuffix: '', dtick: 10 }
        },
        annotations: [
          { text: "% CH‚ÇÑ ‚Üí",  x: 0.25, y: 0.5,  textangle: -60, showarrow: false, font: { size: 14, color: '#003399' } },
          { text:" % C‚ÇÇH‚ÇÑ ‚Üí", x: 0.75, y: 0.5,  textangle: 60,  showarrow: false, font: { size: 14, color: '#003399' } },
          { text: "‚Üê % C‚ÇÇH‚ÇÜ", x: 0.5,  y: -0.15,textangle: 0,   showarrow: false, font: { size: 14, color: '#003399' } }
        ],
        title: 'Duval Triangle 7 FOR THERMAL FAULT (FR3 OIL)',
        height: 500
      });

      showToast("Import Excel selesai ‚Äî titik hitam ditampilkan");
      e.target.value = "";
    };

    reader.readAsArrayBuffer(file);
  });

  function downloadExcel() {
    let csv = "No,UP,Trafo,Tanggal Uji,Tanggal Input,CH4,C2H4,C2H6,Fault,Rekomendasi\n";

    hasilData.forEach((d, i) => {
      const r = (d.rekom || "").replace(/,/g, ";");
      csv += `${i + 1},${d.up || "-"},${d.trafo || "-"},${d.tanggalUji || "-"},${d.tanggalInput || "-"},${d.ch4},${d.c2h4},${d.c2h6},"${d.fault}","${r}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Riwayat_Duval7_FOR_THERMAL_FAULT_FR3 OIL.csv";
    a.click();

    showToast("CSV berhasil diunduh!");
  }

  function showToast(msg = "Data disimpan ke Excel") {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  }
</script>
</body>
</html>
