<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DGA Check | THE Duval Triangle 1 Mineral Oil</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Filter header (Excel-style) */
    .filterable { position: relative; cursor: pointer; }
    .filter-arrow { font-size: 12px; margin-left: 6px; }
    .filter-menu {
      display: none;
      position: absolute;
      top: 28px;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      z-index: 9999;
      min-width: 150px;
      max-height: 220px;
      overflow-y: auto;
      padding: 6px;
      border-radius: 6px;
    }
    .filter-menu div { padding: 6px 10px; border-radius: 4px; color: #000; white-space: nowrap; }
    .filter-menu div:hover { background: #eef2ff; cursor: pointer; }

    /* General UI */
    body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fb; margin: 0; padding: 0; }
    header { background-color: #003399; color: white; padding: 15px 40px; font-size: 20px; font-weight: bold; }
    .main { display:flex; justify-content:space-between; margin:20px auto; width:90%; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); padding:20px;}
    .input-section { width:30%; }
    .chart-section { width:65%; }
    label { font-weight:600; display:block; margin-top:10px; }
    input { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
    button { background-color:#003399; color:white; border:none; padding:10px 15px; border-radius:5px; margin-top:15px; font-weight:bold; cursor:pointer;}
    button:hover { background-color:#001f66; }
    #hasilContainer {width: 90%; margin: 20px auto;}
    .hasil { background-color:#eef2ff; border-left:5px solid #003399; padding:20px; border-radius:6px; font-size:20px; min-height:140px; width:100%; box-sizing: border-box;}
    .hasil b { color:#001f66; }
    h2 { color:#003399; font-size:18px; border-bottom:2px solid #003399; padding-bottom:5px; margin:0 0 10px 0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th { background-color:#003399; color:white; padding:10px; text-align:center; position:relative; }
    td { border:1px solid #ddd; padding:8px; text-align:center; }
    .action-buttons { margin-top:15px; text-align:right; }
    .btn-excel { background-color:#003399; margin-right:10px; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn-delete { background-color:#c62828; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    footer { background-color:#003399; color:white; text-align:center; padding:10px; margin-top:40px; }
    .toast { position:fixed; bottom:25px; right:25px; background-color:#003399; color:white; padding:10px 16px; border-radius:6px; opacity:0; transition:opacity 0.4s ease; pointer-events:none; font-size:14px; }
    .toast.show { opacity:1; pointer-events:auto; }

    /* Help popup */
    .help-btn { position: fixed; bottom: 25px; right: 25px; width: 45px; height: 45px; border-radius: 50%; background: #1976d2; color: #fff; font-size: 22px; border: none; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.25); z-index: 999; }
    .help-popup { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); backdrop-filter: blur(3px); }
    .help-content { background: #fff; width: 60%; max-width: 650px; margin: 3% auto; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease; }
    .close-help { float: right; font-size: 28px; cursor: pointer; color: #666; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    .input-select { width: 100%; padding: 10px 14px; border: 1px solid #d0d7e2; border-radius: 8px; font-size: 15px; background: white; cursor: pointer; }
    .input-select:focus { border-color: #1a73e8; box-shadow: 0 0 4px rgba(26,115,232,0.4); outline: none; }

    /* small responsive tweak */
    @media (max-width: 980px) {
      .main { display:block; width:95%; }
      .input-section, .chart-section { width:100%; }
    }
  </style>
</head>
<body>

<header>DGA Check | THE Duval Triangle 1 Mineral Oil</header>
  <a href="Halaman ke 2.html"
     style="text-decoration:none; background-color:#003399; color:white; padding:8px 14px; border-radius:6px; position:absolute; right:40px; top:12px; font-size:15px; transition:background-color 0.2s;">
     ‚¨Ö Kembali
  </a>
</header>

<div class="main">
  <div class="input-section">
    <h2>Analisis Duval Triangle 1 Mineral Oil</h2>

    <div class="row">
      <select id="upSelect" class="input-select"></select>
      <button id="btnDeleteUP" class="btn-small" style="display:none;">Hapus UP</button>
    </div>

    <div class="row">
      <select id="trafoSelect" class="input-select"></select>
      <button id="btnDeleteTrafo" class="btn-small" style="display:none;">Hapus Trafo</button>
    </div>

    <div class="row">
      <button id="btnAddUP" class="btn-small">Tambah UP</button>
      <button id="btnAddTrafo" class="btn-small">Tambah Trafo</button>
    </div>

    <label for="tanggalUji">Tanggal Pengujian</label>
    <input id="tanggalUji" type="date">

    <label for="ch4">CH‚ÇÑ (Methane):</label>
    <input id="ch4" type="number" placeholder="contoh: 20" />

    <label for="c2h4">C‚ÇÇH‚ÇÑ (Ethylene):</label>
    <input id="c2h4" type="number" placeholder="contoh: 30" />

    <label for="c2h2">C‚ÇÇH‚ÇÇ (Acetylene):</label>
    <input id="c2h2" type="number" placeholder="contoh: 10" />

    <div class="button-row">
      <button onclick="hitungDanPlot()">Hitung & Simpan</button>
      <input type="file" id="excelFile" accept=".xlsx, .xls" class="btn-import">
    </div>
  </div>

  <!-- Grafik di kanan -->
  <div class="chart-section">
    <div id="duvalPlot" style="width:100%; height:500px;"></div>
  </div>
</div>

<!-- HASIL ANALISIS SEKARANG DIPINDAHKAN KE SINI -->
<div id="hasilContainer">
  <div class="hasil" id="hasilText">Hasil analisis akan muncul di sini.</div>
</div>


<!-- Riwayat Analisis -->
<div class="container" style="width:90%; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1);">
  <h2>Riwayat Analisis</h2>

  <table id="hasilTable">
    <thead>
      <tr>
        <th>No</th>

        <th class="filterable" data-col="up">
          UP <span class="filter-arrow">‚ñº</span>
          <div class="filter-menu" id="filterUPMenu"></div>
        </th>

        <th class="filterable" data-col="trafo">
          Trafo <span class="filter-arrow">‚ñº</span>
          <div class="filter-menu" id="filterTrafoMenu"></div>
        </th>

        <th>Tanggal Uji</th>
        <th>Tanggal Input</th>
        <th>CH‚ÇÑ</th>
        <th>C‚ÇÇH‚ÇÑ</th>
        <th>C‚ÇÇH‚ÇÇ</th>
        <th>Fault</th>
        <th>Rekomendasi</th>
        <th>üóëÔ∏è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="action-buttons">
    <button class="btn-excel" onclick="downloadExcel()">üì• Unduh Excel</button>
    <button class="btn-delete" onclick="hapusSemua()">üóëÔ∏è Hapus Semua</button>
  </div>
</div>

<!-- ===============================
     GRAFIK TREN GAS DGA
=============================== -->
<div style="width:90%; margin:30px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1);">
  <h2>Monitoring DGA Transformator</h2>

<div style="width:90%; margin:30px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1);">
  <div id="grafikGas" style="width:100%; height:350px;"></div>
</div>
</div>


<footer>¬© 2025 DGA Check | PLN Nusantara Power</footer>

<div class="toast" id="toast">Data disimpan ke Excel</div>
<button id="helpBtn" class="help-btn">?</button>

<div id="helpPopup" class="help-popup">
  <div class="help-content">
    <span id="closeHelp" class="close-help">&times;</span>
    <h2>Duval Triangle 1 Mineral Oil - Help / Info</h2>
    <p><b>Duval Triangle 1</b> digunakan untuk mendiagnosis kondisi gangguan pada transformator dengan minyak mineral melalui analisis gas terlarut (DGA). Diagram ini memetakan proporsi <b>CH‚ÇÑ</b>, <b>C‚ÇÇH‚ÇÇ</b>, dan <b>C‚ÇÇH‚ÇÑ</b> untuk mengidentifikasi jenis gangguan listrik maupun termal di dalam transformator.</p>
    <p>DT1 mendeteksi kategori fault seperti <b>partial discharge (PD)</b>, <b>low-energy arcing (D1)</b>, <b>high-energy arcing (D2)</b>, dan <b>thermal faults</b> (T1/T2/T3).</p>
    <h3>Catatan:</h3>
    <p>Disarankan menetapkan baseline unit masing-masing. Hasil DGA yang keluar dari baseline memerlukan perhatian lebih lanjut.</p>
  </div>
</div>

<!-- ===================================
      JAVASCRIPT POPUP + FILTER + LOGIC UTAMA
==================================== -->
<script>
  // Help popup handlers (minimal & safe)
  const helpBtn = document.getElementById("helpBtn");
  const helpPopup = document.getElementById("helpPopup");
  const closeHelp = document.getElementById("closeHelp");

  helpBtn.onclick = () => helpPopup.style.display = "block";
  closeHelp.onclick = () => helpPopup.style.display = "none";

  window.onclick = (e) => {
    if (e.target === helpPopup) helpPopup.style.display = "none";
  };
</script>

<script>
  /* ===========================
       FILTER HEADER (Excel-style)
     =========================== */
  let activeUPFilter = "";
  let activeTrafoFilter = "";
  let dataTersaring = [];


  function refreshFilterMenus() {
    const upMenu = document.getElementById("filterUPMenu");
    const trafoMenu = document.getElementById("filterTrafoMenu");
    if (!upMenu || !trafoMenu) return;

    const uniqueUP = [...new Set(hasilData.map(r => r.up))].filter(x => x && x !== "-").sort();
    const uniqueTrafo = [...new Set(hasilData.map(r => r.trafo))].filter(x => x && x !== "-").sort();

    upMenu.innerHTML =
      `<div data-value="">(Semua)</div>` +
      uniqueUP.map(u => `<div data-value="${escapeHtml(u)}">${escapeHtml(u)}</div>`).join("");

    trafoMenu.innerHTML =
      `<div data-value="">(Semua)</div>` +
      uniqueTrafo.map(t => `<div data-value="${escapeHtml(t)}">${escapeHtml(t)}</div>`).join("");

    // bind clicks
    upMenu.querySelectorAll("div").forEach(div => {
      div.onclick = () => {
        activeUPFilter = div.dataset.value;
        applyFilterHeader();
        upMenu.style.display = "none";
      };
    });

    trafoMenu.querySelectorAll("div").forEach(div => {
      div.onclick = () => {
        activeTrafoFilter = div.dataset.value;
        applyFilterHeader();
        trafoMenu.style.display = "none";
      };
    });
  }

function applyFilterHeader() {
  dataTersaring = hasilData.filter(row => {
    const matchUP = !activeUPFilter || row.up === activeUPFilter;
    const matchTrafo = !activeTrafoFilter || row.trafo === activeTrafoFilter;
    return matchUP && matchTrafo;
  });

  updateTable(dataTersaring);
  updateGrafikTrend(dataTersaring); // ‚Üê INI YANG BARU
}


  // toggle menus by clicking arrow
  document.addEventListener("click", function (e) {
    if (e.target.classList && e.target.classList.contains("filter-arrow")) {
      const th = e.target.closest("th");
      const col = th.dataset.col;

      // close all first
      document.querySelectorAll(".filter-menu").forEach(m => (m.style.display = "none"));

      const menu = col === "up" ? document.getElementById("filterUPMenu") : document.getElementById("filterTrafoMenu");
      if (menu) menu.style.display = "block";
    } else {
      // click outside -> close
      if (!e.target.closest(".filter-menu") && !e.target.classList.contains("filter-arrow")) {
        document.querySelectorAll(".filter-menu").forEach(m => (m.style.display = "none"));
      }
    }
  });

  // small escape helper for insertion into menu
  function escapeHtml(s) {
    if (!s && s !== 0) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }
</script>

<script>
  //DATABASE PLN NP (kehilangan data tetap aman, stored di localStorage)
  let databaseUP = {
    "UP Paiton": ["Generator Transformer #1", "Generator Transformer #2","Generator Transformer #9","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2","Unit Auxiliary Transformer #9"],
    "UP Indramayu": ["Generator Transformer #1", "Generator Transformer #2", "Generator Transformer #3","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2","Unit Auxiliary Transformer #3"],
    "UP Rembang": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Pacitan": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Tanjung Awar-Awar": ["Generator Transformer #1","Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Kaltim Teluk": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Pulang Pisau": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Tenayan": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Sambelia": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Naga Raya": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Bukit Asam": ["Generator Transformer #1", "Generator Transformer #2", "Generator Transformer #3","Generator Transformer #4","Unit Auxiliary Transformer #2","Unit Auxiliary Transformer #3","Unit Auxiliary Transformer #4"],
    "UP Tarahan": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Sebalang": ["Generator Transformer #1", "TGenerator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"],
    "UP Punagaya": ["Generator Transformer #1", "Generator Transformer #2","Unit Auxiliary Transformer #1","Unit Auxiliary Transformer #2"]
  };

  databaseUP = JSON.parse(localStorage.getItem("dbUpTrafo")) || databaseUP;
  const saveDB = () => localStorage.setItem("dbUpTrafo", JSON.stringify(databaseUP));

  /* ===========================
     LOAD UP & TRAFO DARI DB
     =========================== */
  function loadUP() {
    const upSel = document.getElementById("upSelect");
    upSel.innerHTML = `<option value="">-- Pilih UP --</option>` +
      Object.keys(databaseUP).map(u => `<option>${u}</option>`).join("");
  }

  function loadTrafo(up) {
    const trSel = document.getElementById("trafoSelect");
    trSel.innerHTML = `<option value="">-- Pilih Trafo --</option>`;
    if (!up) return;
    trSel.innerHTML += databaseUP[up].map(t => `<option>${t}</option>`).join("");
  }

  document.getElementById("upSelect").addEventListener("change", function () {
    const up = this.value;
    loadTrafo(up);
    document.getElementById("btnDeleteUP").style.display = up ? "inline-block" : "none";
  });

  document.getElementById("trafoSelect").addEventListener("change", function () {
    const tr = this.value;
    document.getElementById("btnDeleteTrafo").style.display = tr ? "inline-block" : "none";
  });

  document.getElementById("btnAddUP").addEventListener("click", () => {
    const newUP = prompt("Nama UP baru:");
    if (!newUP) return;
    if (databaseUP[newUP]) return alert("UP sudah ada!");
    databaseUP[newUP] = [];
    saveDB();
    loadUP();
  });

  document.getElementById("btnAddTrafo").addEventListener("click", () => {
    const up = document.getElementById("upSelect").value;
    if (!up) return alert("Pilih UP dulu!");
    const newTrafo = prompt("Nama trafo baru:");
    if (!newTrafo) return;
    databaseUP[up].push(newTrafo);
    saveDB();
    loadTrafo(up);
  });

  document.getElementById("btnDeleteUP").addEventListener("click", () => {
    const up = document.getElementById("upSelect").value;
    if (!up) return;
    if (confirm(`Hapus UP "${up}" beserta seluruh Trafonya?`)) {
      delete databaseUP[up];
      saveDB();
      loadUP();
      document.getElementById("trafoSelect").innerHTML = `<option value="">-- Pilih Trafo --</option>`;
      document.getElementById("btnDeleteUP").style.display = "none";
      document.getElementById("btnDeleteTrafo").style.display = "none";
    }
  });

  document.getElementById("btnDeleteTrafo").addEventListener("click", () => {
    const up = document.getElementById("upSelect").value;
    const tr = document.getElementById("trafoSelect").value;
    if (!tr) return;
    if (confirm(`Hapus Trafo "${tr}"?`)) {
      databaseUP[up] = databaseUP[up].filter(t => t !== tr);
      saveDB();
      loadTrafo(up);
      document.getElementById("btnDeleteTrafo").style.display = "none";
    }
  });

  document.addEventListener("DOMContentLoaded", loadUP);
</script>

<script>
  // Saat halaman pertama kali dibuka: plot kosong
  document.addEventListener("DOMContentLoaded", () => {
    plotDuval(0, 0, 0, null);
  });

  // Isi default tanggal uji = hari ini kalau belum diisi
  document.addEventListener("DOMContentLoaded", function () {
    const today = new Date().toISOString().split("T")[0];
    const tUji = document.getElementById("tanggalUji");
    if (tUji && !tUji.value) {
      tUji.value = today;
    }
  });

  const STORAGE_KEY = "riwayat_duval1_MineralOil";
  let hasilData = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  // Regions for Duval triangle
  const regions = [
    { name: 'PD', color: 'rgba(255, 235, 59, 0.7)', coords: [ [100,-1,-1], [100,3,0], [100,0,3] ] },
    { name: 'T1', color: 'rgba(66,133,244,0.55)', coords: [ [100,0,3],[100,3,0],[100,4,-1],[80,4,21],[80,-1,20] ] },
    { name: 'T2', color: 'rgba(73,71,16,0.55)', coords: [ [80,-1,20],[80,4,21],[735,55,798],[74,-1,74] ] },
    { name: 'T3', color: 'rgba(244,67,54,0.25)', coords: [ [74,-1,74],[53,22,75],[-1,17,100],[-1,-1,100] ] },
    { name: 'DT', color: 'rgba(102,187,106,0.35)', coords: [ [100,4,-1],[100,14,-1],[52,15,44],[50,47,65],[-1,40,100],[-1,17,100],[53,22,75],[735,55,798] ] },
    { name: 'D1', color: 'rgba(255,167,38,0.4)', coords: [ [100,14,-1],[1000,203,360],[-1,67,20],[-1,100,-1] ] },
    { name: 'D2', color: 'rgba(50,17,38,0.4)', coords: [ [-1,67,20],[1000,203,360],[95,27,80],[50,47,65],[-1,40,100] ] }
  ];

  // ternary ‚Üí xy
  function ternaryToXY(a, b, c) {
    const s = a + b + c;
    if (s === 0) return { x: 0, y: 0 };
    const an = a / s, bn = b / s, cn = c / s;
    const sqrt3over2 = Math.sqrt(3) / 2;
    return { x: 1 - (0.5 * an + cn), y: an * sqrt3over2 };
  }

  function pointInPolygon2D(point, polygon) {
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i].x, yi = polygon[i].y;
      const xj = polygon[j].x, yj = polygon[j].y;
      const intersect = ((yi > point.y) !== (yj > point.y)) &&
        (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  function detectRegionForPoint(a, b, c) {
    const pt = ternaryToXY(a, b, c);
    for (let r of regions) {
      const poly = r.coords.map(p => ternaryToXY(p[0], p[2], p[1]));
      if (pointInPolygon2D(pt, poly)) return r;
    }
    return null;
  }

  // HITUNG & SIMPAN
  function hitungDanPlot() {
    const up    = document.getElementById("upSelect").value || "-";
    const trafo = document.getElementById("trafoSelect").value || "-";

    const today = new Date().toISOString().split("T")[0];
    const tUjiInput = document.getElementById("tanggalUji").value;
    const tanggalUji   = tUjiInput || today;
    const tanggalInput = today;

    const ch4  = parseFloat(document.getElementById("ch4").value);
    const c2h4 = parseFloat(document.getElementById("c2h4").value);
    const c2h2 = parseFloat(document.getElementById("c2h2").value);

    if (!up || !trafo) { alert("Pilih UP dan Trafo terlebih dahulu!"); return; }
    if (isNaN(ch4) || isNaN(c2h4) || isNaN(c2h2) || (ch4 + c2h4 + c2h2) === 0) { alert("Isi semua nilai gas dengan benar!"); return; }

    const total = ch4 + c2h4 + c2h2;
    const pCH4  = (ch4  / total) * 100;
    const pC2H4 = (c2h4 / total) * 100;
    const pC2H2 = (c2h2 / total) * 100;

    // low normal
    if (ch4 < 25 && c2h4 < 20 && c2h2 < 2) {
      const hasilLow = "Low Normal";
      const rekomLow = ["Peralatan dalam kondisi normal.","Monitoring rutin sesuai jadwal.","Tidak diperlukan tindakan korektif."];
      document.getElementById("hasilText").innerHTML = `<b>Hasil:</b> ${hasilLow}<br><b>Rekomendasi:</b><ol>${rekomLow.map(r => `<li>${r}</li>`).join('')}</ol>`;

      hasilData.push({ up, trafo, tanggalUji, tanggalInput, ch4, c2h4, c2h2, fault: hasilLow, rekom: rekomLow.join("; ") });
      saveToStorage();
      updateTable();
      refreshFilterMenus();
      applyFilterHeader();
      Plotly.purge("duvalPlot");
      return;
    }

    const found = detectRegionForPoint(pCH4, pC2H4, pC2H2);
    const fault = found ? found.name : "Tidak terklasifikasi";
    const info  = rekomendasiMap[fault];

    document.getElementById("hasilText").innerHTML = info ? `<b>Hasil:</b> ${info.hasil}<br><b>Rekomendasi:</b><ol>${info.rekom.map(r=>`<li>${r}</li>`).join('')}</ol>` : `<b>Hasil:</b> ${fault}`;

    hasilData.push({ up, trafo, tanggalUji, tanggalInput, ch4, c2h4, c2h2, fault, rekom: info ? info.rekom.join("; ") : "-" });
    saveToStorage();
    updateTable();
    refreshFilterMenus();
    applyFilterHeader();
    plotDuval(pCH4, pC2H4, pC2H2, found);
  }

  // PLOT DUVAL (ternary via plotly)
  function plotDuval(aVal = 0, bVal = 0, cVal = 100, foundRegion = null) {
    const traces = regions.map(r => ({
      type: 'scatterternary',
      mode: 'lines',
      fill: 'toself',
      fillcolor: r.color,
      line: { color: 'black', width: 1 },
      name: r.name,
      a: r.coords.map(p => p[0]),
      b: r.coords.map(p => p[1]),
      c: r.coords.map(p => p[2])
    }));

    const point = {
      type: 'scatterternary',
      mode: 'markers',
      a: [aVal],
      b: [cVal],
      c: [bVal],
      marker: { color: foundRegion ? foundRegion.color : 'black', size: 14, line: { color: '#222', width: 1 } },
      name: 'Hasil'
    };

    const layout = {
      ternary: { sum: 100, aaxis: { title: '', dtick: 10 }, baxis: { title: '', dtick: 10 }, caxis: { title: '', dtick: 10 } },
      annotations: [
        { text: "% CH‚ÇÑ ‚Üí", x: 0.22, y: 0.5, textangle: -60, showarrow: false, font: { size: 14, color: '#003399' } },
        { text: "% C‚ÇÇH‚ÇÑ ‚Üí", x: 0.78, y: 0.5, textangle: 60, showarrow: false, font: { size: 14, color: '#003399' } },
        { text: "‚Üê % C‚ÇÇH‚ÇÇ", x: 0.5, y: -0.15, textangle: 0, showarrow: false, font: { size: 14, color: '#003399' } }
      ],
      title: 'Duval Triangle 1 Mineral Oil',
      height: 500,
      showlegend: true,
      legend: { orientation: 'h', x: 0.1, y: -0.12 }
    };

    Plotly.react('duvalPlot', [point, ...traces], layout);
  }

  // rekomendasi map
  const rekomendasiMap = {
    "PD": { hasil: "Partial Discharge (PD)", rekom: ["Verifikasi hasil sampling dan kondisi oil sampling bottle.","Lakukan peningkatan frekuensi pengambilan sampel DGA menjadi setiap 1‚Äì2 minggu.","Lakukan inspeksi visual terhadap bushing, isolator, dan sistem pendingin.","Laksanakan PD test (UHF/TEV) bila perlu."] },
    "D1": { hasil: "Low Energy Discharge (D1)", rekom: ["Periksa terminal, koneksi kabel, dan bagian penghubung.","Pengencangan koneksi dan pembersihan area korosi atau indikasi percikan kecil.","Lakukan thermography untuk mendeteksi hotspot lokal.","Ambil ulang sampel setelah perbaikan."] },
    "D2": { hasil: "High Energy Discharge (D2)", rekom: ["Segera beri notifikasi ke unit operasi.","Aktifkan DGA online jika ada.","Kurangi beban sementara dan evaluasi pendinginan.","Rencanakan outage untuk pemeriksaan internal."] },
    "T1": { hasil: "Thermal Fault <300¬∞C (T1)", rekom: ["Periksa sistem pendingin (radiator, fan, oil pump).","Lakukan filtrasi oli dan pastikan sirkulasi baik.","Pantau beban dan pastikan tidak melebihi rating."] },
    "T2": { hasil: "Thermal Fault 300‚Äì700¬∞C (T2)", rekom: ["Lakukan furan test untuk menilai degradasi kertas isolasi.","Kurangi beban operasional transformator.","Rencanakan outage bila diperlukan."] },
    "T3": { hasil: "Thermal Fault >700¬∞C (T3)", rekom: ["Segera evaluasi kondisi internal trafo.","Jadwalkan shutdown terkontrol untuk inspeksi.","Ganti winding/isolasi bila perlu."] },
    "DT": { hasil: "Discharge + Thermal Fault (DT)", rekom: ["Investigasi kombinasi pelepasan listrik dan pemanasan lokal.","Pantau tren gas secara berkala (1‚Äì2 minggu).","Ambil tindakan korektif sesuai inspeksi."] }
  };

  // UPDATE TABEL
  function updateTable(data = hasilData) {
    const tbody = document.querySelector("#hasilTable tbody");
    if (!data || !data.length) {
      tbody.innerHTML = `<tr><td colspan="10" style="color:#888; text-align:center;">Belum ada data</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map((d, i) => {
      const rekomList = d.rekom && d.rekom !== "-" ? d.rekom.split(";").map((r, idx) => `<div>${idx+1}. ${escapeHtml(r.trim())}</div>`).join("") : "-";
      return `<tr>
  <td>${i+1}</td>
  <td>${escapeHtml(d.up || "-")}</td>
  <td>${escapeHtml(d.trafo || "-")}</td>
  <td>${escapeHtml(d.tanggalUji || "-")}</td>
  <td>${escapeHtml(d.tanggalInput || "-")}</td>
  <td>${d.ch4}</td>
  <td>${d.c2h4}</td>
  <td>${d.c2h2}</td>
  <td>${escapeHtml(d.fault)}</td>
  <td>${rekomList}</td>
  <td>
    <button 
      class="btn-delete"
      onclick="hapusSatu(${hasilData.indexOf(d)})"
      title="Hapus baris ini">
      üóë
    </button>
  </td>
</tr>`;

    }).join("");
  }

  function hapusSemua(){
    if(confirm("Hapus semua riwayat analisis?")){
      hasilData = [];
      localStorage.removeItem(STORAGE_KEY);
      updateTable();
      refreshFilterMenus();
      applyFilterHeader();
    }
  }

  function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(hasilData));
  }
    function hapusSatu(index){
  if (index < 0) return;

  if (!confirm("Hapus data analisis ini?")) return;

  hasilData.splice(index, 1);
  saveToStorage();

  updateTable();
  refreshFilterMenus();
  applyFilterHeader();
    }

  // helper tanggal excel
  function safeExcelDate(value) {
    if (!value) return "-";
    if (value instanceof Date) return value.toISOString().split("T")[0];
    if (typeof value === "number") {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const d = new Date(excelEpoch.getTime() + value * 86400000);
      return d.toISOString().split("T")[0];
    }
    if (typeof value === "string") {
      const d = new Date(value);
      if (!isNaN(d)) return d.toISOString().split("T")[0];
      return value;
    }
    return "-";
  }

  /* ==============
     Excel Import
     ============== */
  document.getElementById('excelFile').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
      const today = new Date().toISOString().split("T")[0];

      rows.forEach(row => {
        const up = row.UP || row["Nama UP"] || "-";
        const trafo = row.Trafo || row["Nama Trafo"] || "-";
        const tanggalUji = safeExcelDate(row["Tanggal Uji"] || row.Tanggal || "");
        const tanggalInput = today;
        const ch4 = Number(row.CH4 || 0);
        const c2h4 = Number(row.C2H4 || 0);
        const c2h2 = Number(row.C2H2 || 0);
        if ((ch4 + c2h4 + c2h2) === 0) return;

        if (ch4 < 25 && c2h4 < 20 && c2h2 < 2) {
          const rekomLowNormal = ["Peralatan dalam kondisi normal.","Lakukan monitoring rutin sesuai jadwal.","Tidak diperlukan tindakan korektif."];
          hasilData.push({ up, trafo, tanggalUji, tanggalInput, ch4, c2h4, c2h2, fault: "NORMAL", rekom: rekomLowNormal.join("; ") });
          return;
        }

        const total = ch4 + c2h4 + c2h2;
        const pCH4 = (ch4/total)*100;
        const pC2H4 = (c2h4/total)*100;
        const pC2H2 = (c2h2/total)*100;

        const found = detectRegionForPoint(pCH4, pC2H4, pC2H2);
        const fault = found ? found.name : "Tidak terklasifikasi";
        const info = rekomendasiMap[fault];

        hasilData.push({ up, trafo, tanggalUji, tanggalInput, ch4, c2h4, c2h2, fault, rekom: info ? info.rekom.join("; ") : "-" });
      });

      saveToStorage();
      updateTable();
      refreshFilterMenus();
      applyFilterHeader();

      // replot historical points (kecuali NORMAL)
      Plotly.purge('duvalPlot');
      const traces = hasilData.filter(d => d.fault !== "NORMAL").map((d,i) => {
        const total = d.ch4 + d.c2h4 + d.c2h2;
        if (total === 0) return null;
        const pCH4 = (d.ch4/total)*100;
        const pC2H4 = (d.c2h4/total)*100;
        const pC2H2 = (d.c2h2/total)*100;
        return {
          type: 'scatterternary',
          mode: 'markers+text',
          a: [pCH4],
          b: [pC2H2],
          c: [pC2H4],
          marker: { size: 10, color: 'black', symbol: 'circle', line: { color: 'white', width: 1 } },
          text: [`S${i+1}`],
          textposition: 'top center',
          showlegend: false
        };
      }).filter(Boolean);

      const areaTraces = regions.map(r => ({
        type: 'scatterternary',
        mode: 'lines',
        fill: 'toself',
        fillcolor: r.color,
        line: { color: 'black', width: 1 },
        name: r.name,
        a: r.coords.map(p => p[0]),
        b: r.coords.map(p => p[1]),
        c: r.coords.map(p => p[2])
      }));

      Plotly.react('duvalPlot', [...areaTraces, ...traces], {
        ternary: { sum: 100, aaxis: { dtick: 10 }, baxis: { dtick: 10 }, caxis: { dtick: 10 } },
        annotations: [
          { text: "% CH‚ÇÑ ‚Üí", x: 0.22, y: 0.5, textangle: -60, showarrow: false, font: { size: 14, color: '#003399' } },
          { text: "% C‚ÇÇH‚ÇÑ ‚Üí", x: 0.78, y: 0.5, textangle: 60, showarrow: false, font: { size: 14, color: '#003399' } },
          { text: "‚Üê % C‚ÇÇH‚ÇÇ", x: 0.5, y: -0.15, textangle: 0, showarrow: false, font: { size: 14, color: '#003399' } }
        ],
        title: 'Duval Triangle 1 Mineral Oil',
        height: 500
      });

      showToast("Import Excel selesai ‚Äî titik hitam ditampilkan");
      e.target.value = "";
    };
    reader.readAsArrayBuffer(file);
  });

  function downloadExcel() {
    let csv = "No,UP,Trafo,Tanggal Uji,Tanggal Input,CH4,C2H4,C2H2,Fault,Rekomendasi\n";
    hasilData.forEach((d,i) => {
      const r = (d.rekom || "").replace(/,/g, ";");
      csv += `${i+1},${d.up || "-"},${d.trafo || "-"},${d.tanggalUji || "-"},${d.tanggalInput || "-"},${d.ch4},${d.c2h4},${d.c2h2},"${d.fault}","${r}"\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Riwayat_Duval_Triangle_1_Mineral_Oil.csv";
    a.click();
    showToast("CSV berhasil diunduh!");
  }

  function showToast(msg = "Data disimpan ke Excel") {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  }

  // init table + menus on load
  document.addEventListener("DOMContentLoaded", () => {
    updateTable();
    refreshFilterMenus();
    applyFilterHeader();
  });

/* ===========================
   GRAFIK TREN GAS DGA
   =========================== */

function updateGrafikTrend(data) {
  if (!data || data.length === 0) {
    Plotly.purge("grafikGas");
    return;
  }

  // Urutkan berdasarkan tanggal uji
  data.sort((a, b) => new Date(a.tanggalUji) - new Date(b.tanggalUji));

  const traceCH4 = {
    x: data.map(d => d.tanggalUji),
    y: data.map(d => d.ch4),
    mode: "lines+markers",
    name: "CH‚ÇÑ",
    line: { width: 2 },
    marker: { size: 6 }
  };

  const traceC2H4 = {
    x: data.map(d => d.tanggalUji),
    y: data.map(d => d.c2h4),
    mode: "lines+markers",
    name: "C‚ÇÇH‚ÇÑ",
    line: { width: 2 },
    marker: { size: 6 }
  };

  const traceC2H2 = {
    x: data.map(d => d.tanggalUji),
    y: data.map(d => d.c2h2),
    mode: "lines+markers",
    name: "C‚ÇÇH‚ÇÇ",
    line: { width: 2 },
    marker: { size: 6 }
  };

  const layout = {
    title: "Tren Gas DGA",
    xaxis: {title: "Tanggal Uji", type: "category"},
    yaxis: { title: "Konsentrasi Gas (ppm)" },
    legend: { orientation: "h", x: 0.2, y: -0.25 },
    margin: { t: 50 }
  };

  Plotly.react("grafikGas", [traceCH4, traceC2H4, traceC2H2], layout);
}


function buatGrafikGas(divId, data, label, field) {
  const trace = {
    x: data.map(d => d.tanggalUji),
    y: data.map(d => d[field]),
    mode: "lines+markers",
    name: label
  };

  const layout = {
    title: label + " vs Tanggal Uji",
    xaxis: { title: "Tanggal Uji" },
    yaxis: { title: label + " (ppm)" },
    margin: { t: 40 }
  };

  Plotly.react(divId, [trace], layout);
}

</script>

</body>
</html>


